{"version":3,"file":"synthesized-compiler-host.js","sourceRoot":"","sources":["../../../src/lib/ts/synthesized-compiler-host.ts"],"names":[],"mappings":";;AAAA,iCAAiC;AACjC,uEAAqF;AAErF;;;;;;;GAOG;AACH,qDACE,WAA4B,EAC5B,eAAmC;IAEnC,sEAAsE;IACtE,MAAM,OAAO,GAAG,EAAE,CAAC,kBAAkB,CAAC,eAAe,EAAE,oBAAoB,CAAC,IAAI,CAAC,CAAC;IAElF,MAAM,mBACD,OAAO,IACV,aAAa,EAAE,CAAC,QAAQ,EAAE,OAAO,EAAE,EAAE;YACnC,IAAI,UAAU,GAAG,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,QAAQ,KAAK,QAAQ,CAAC,CAAC;YAEtE,EAAE,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC;gBACf,uEAAuE;gBACvE,4EAA4E;gBAC5E,EAAE,CAAC,CAAC,UAAU,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC;oBAC/B,UAAU,GAAG,UAAU,CAAC,cAAc,CAAC,CAAC,cAAc,CAAC;gBACzD,CAAC;gBAED,4DAA4D;gBAC5D,uFAAuF;gBACvF,EAAE,CAAC,CAAC,CAAC,UAAU,CAAC,oBAAoB,CAAC,IAAI,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;oBAChE,UAAU,CAAC,oBAAoB,CAAC,GAAG,UAAU,CAAC,UAAU,CAAC,CAAC,oBAAoB,CAAC,CAAC;gBAClF,CAAC;gBAED,qFAAqF;gBACrF,6FAA6F;gBAC7F,MAAM,gBAAgB,GAAG,CAAC,UAAU,CAAC,KAAK,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC;gBACtD,EAAE,CAAC,CAAC,gBAAgB,IAAI,iDAAuB,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;oBAC5D,MAAM,CAAC,yCAAe,CAAC,UAAU,CAAC,CAAC;gBACrC,CAAC;gBAED,MAAM,CAAC,UAAU,CAAC;YACpB,CAAC;YAAC,IAAI,CAAC,CAAC;gBACN,MAAM,CAAC,OAAO,CAAC,aAAa,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;YAClD,CAAC;QACH,CAAC,EACD,mBAAmB,EAAE,CAAC,QAAQ,EAAE,IAAI,EAAE,eAAe,EAAE,EAAE;YACvD,MAAM,IAAI,KAAK,CAAC,kBAAkB,CAAC,CAAC;YAEpC,uCAAuC;YACvC,uEAAuE;QACzE,CAAC,IACD;AACJ,CAAC;AA5CD,kGA4CC","sourcesContent":["import * as ts from 'typescript';\r\nimport { isSynthesizedSourceFile, writeSourceFile } from './synthesized-source-file';\r\n\r\n/**\r\n * Creates a TypeScript {@link CompilerHost} that reads source files from a collection. Should\r\n * a source file include synthesized source text replacements, i.e., the source file is a\r\n * {@link SynthesizedSourceFile}, it will apply source text replacements.\r\n *\r\n * @param sourceFiles A collection of TypeScript source files\r\n * @param compilerOptions Compiler options\r\n */\r\nexport function createCompilerHostForSynthesizedSourceFiles(\r\n  sourceFiles: ts.SourceFile[],\r\n  compilerOptions: ts.CompilerOptions\r\n): ts.CompilerHost {\r\n  // FIX(#625): pass `setParentNodes` to the \"synthesized\" compiler host\r\n  const wrapped = ts.createCompilerHost(compilerOptions, /* setParentNodes */ true);\r\n\r\n  return {\r\n    ...wrapped,\r\n    getSourceFile: (fileName, version) => {\r\n      let sourceFile = sourceFiles.find(file => file.fileName === fileName);\r\n\r\n      if (sourceFile) {\r\n        // FIX(#473): typescript has internal notion of \"redirect source files\"\r\n        // Do not return the redirected file, but rather the target of the redirect.\r\n        if (sourceFile['redirectInfo']) {\r\n          sourceFile = sourceFile['redirectInfo'].redirectTarget;\r\n        }\r\n\r\n        // FIX: https://github.com/Microsoft/TypeScript/issues/19950\r\n        // After typescript transformation, `ambientModuleNames` may become undefined. Copy it.\r\n        if (!sourceFile['ambientModuleNames'] && sourceFile['original']) {\r\n          sourceFile['ambientModuleNames'] = sourceFile['original']['ambientModuleNames'];\r\n        }\r\n\r\n        // FIX: `ts.SourceFile` with the synthetic flag cause one of ngc/tsc/tsickle to choke\r\n        // Workaround the issue by creating a fresh source file and copying/replacing the source text\r\n        const hasSyntheticFlag = (sourceFile.flags & 8) !== 0;\r\n        if (hasSyntheticFlag || isSynthesizedSourceFile(sourceFile)) {\r\n          return writeSourceFile(sourceFile);\r\n        }\r\n\r\n        return sourceFile;\r\n      } else {\r\n        return wrapped.getSourceFile(fileName, version);\r\n      }\r\n    },\r\n    getSourceFileByPath: (fileName, path, languageVersion) => {\r\n      throw new Error(`Not implemented.`);\r\n\r\n      // console.warn('getSourceFileByPath');\r\n      // return wrapped.getSourceFileByPath(fileName, path, languageVersion);\r\n    }\r\n  };\r\n}\r\n"]}